#!/usr/bin/env node

/**
 * Script para for√ßar a gera√ß√£o do Prisma Client SEM Data Proxy
 * Este script garante que todas as vari√°veis de ambiente est√£o configuradas
 * e limpa qualquer cache antes de gerar o Prisma Client
 */

const { execSync } = require("child_process");
const fs = require("fs");
const path = require("path");

const projectRoot = path.join(__dirname, "..");
const generatedPrismaPath = path.join(projectRoot, "src", "generated", "prisma");
const dotPrismaPath = path.join(projectRoot, "node_modules", ".prisma");

console.log("üîß For√ßando gera√ß√£o do Prisma Client sem Data Proxy...");

// Limpar diret√≥rios gerados
const dirsToClean = [generatedPrismaPath, dotPrismaPath];
dirsToClean.forEach((dir) => {
  if (fs.existsSync(dir)) {
    console.log(`Limpando: ${dir}`);
    try {
      fs.rmSync(dir, { recursive: true, force: true });
    } catch (error) {
      console.warn(`‚ö† N√£o foi poss√≠vel limpar ${dir}:`, error.message);
    }
  }
});

// Configurar vari√°veis de ambiente explicitamente
const env = {
  ...process.env,
  // For√ßar desabilita√ß√£o do Data Proxy
  PRISMA_GENERATE_DATAPROXY: "false",
  PRISMA_CLIENT_ENGINE_TYPE: "library",
  PRISMA_CLI_QUERY_ENGINE_TYPE: "library",
  // Remover qualquer vari√°vel que possa for√ßar Data Proxy
};

// Deletar vari√°veis que podem for√ßar Data Proxy
delete env.PRISMA_CLIENT_DATAPROXY_URL;
delete env.DATAPROXY_URL;
delete env.PRISMA_ENGINES_MIRROR;

// Verificar DATABASE_URL
if (env.DATABASE_URL) {
  if (env.DATABASE_URL.startsWith("prisma://") || env.DATABASE_URL.startsWith("prisma+")) {
    console.error("‚ùå ERRO: DATABASE_URL est√° configurada para usar Prisma Data Proxy!");
    console.error("Configure DATABASE_URL com uma string de conex√£o MongoDB direta (ex: mongodb+srv://...)");
    process.exit(1);
  }
  console.log("‚úì DATABASE_URL configurada (n√£o √© Data Proxy)");
} else {
  console.warn("‚ö† DATABASE_URL n√£o est√° definida (pode estar configurada na Vercel)");
}

console.log("Vari√°veis de ambiente configuradas:");
console.log(`  PRISMA_GENERATE_DATAPROXY=${env.PRISMA_GENERATE_DATAPROXY}`);
console.log(`  PRISMA_CLIENT_ENGINE_TYPE=${env.PRISMA_CLIENT_ENGINE_TYPE}`);
console.log(`  PRISMA_CLI_QUERY_ENGINE_TYPE=${env.PRISMA_CLI_QUERY_ENGINE_TYPE}`);

// Executar prisma generate
try {
  console.log("\nüì¶ Executando: npx prisma generate");
  execSync("npx prisma generate", {
    cwd: projectRoot,
    stdio: "inherit",
    env: env,
  });
  console.log("\n‚úì Prisma Client gerado com sucesso (sem Data Proxy)");
} catch (error) {
  console.error("\n‚ùå Erro ao gerar Prisma Client:", error.message);
  process.exit(1);
}

// Verificar se o client foi gerado corretamente
const clientIndexPath = path.join(generatedPrismaPath, "index.js");
if (fs.existsSync(clientIndexPath)) {
  const clientContent = fs.readFileSync(clientIndexPath, "utf8");
  
  // Verificar se h√° refer√™ncias ao Data Proxy
  if (clientContent.includes("prisma://") || clientContent.includes("prisma+") || clientContent.includes("dataproxy")) {
    console.error("\n‚ùå ERRO: Prisma Client foi gerado com Data Proxy habilitado!");
    console.error("Isso n√£o deveria acontecer. Verifique as configura√ß√µes.");
    process.exit(1);
  }
  
  // Verificar se est√° usando library engine
  if (clientContent.includes("engineType") && !clientContent.includes("library")) {
    console.warn("\n‚ö† Aviso: Engine type pode n√£o estar configurado como 'library'");
  }
  
  console.log("‚úì Verifica√ß√£o: Prisma Client n√£o est√° usando Data Proxy");
} else {
  console.warn("\n‚ö† Arquivo index.js n√£o encontrado ap√≥s gera√ß√£o");
}

// Criar/atualizar arquivo enums.ts
const enumsFile = path.join(generatedPrismaPath, "enums.ts");
const enumsContent = `/* !!! This is code generated by Prisma. Do not edit directly. !!! */
/* eslint-disable */
// biome-ignore-all lint: generated file
// @ts-nocheck 
/*
* This file exports all enum related types from the schema.
*
* üü¢ You can import this file directly.
*/

// Re-export enums from the main Prisma client
export {
  Role,
  type Role as RoleType,
  EstablishmentPlan,
  type EstablishmentPlan as EstablishmentPlanType,
  DeliveryStatus,
  type DeliveryStatus as DeliveryStatusType,
  AssignmentStatus,
  type AssignmentStatus as AssignmentStatusType,
} from './index';
`;

try {
  fs.writeFileSync(enumsFile, enumsContent, "utf8");
  console.log("‚úì Arquivo enums.ts criado/atualizado");
} catch (error) {
  console.error("‚ùå Erro ao criar enums.ts:", error.message);
  process.exit(1);
}

console.log("\n‚úÖ Conclu√≠do!");

